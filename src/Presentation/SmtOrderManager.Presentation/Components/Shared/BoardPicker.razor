@using MediatR
@using SmtOrderManager.Application.Features.Boards.Queries.GetAllBoards
@using SmtOrderManager.Domain.Entities

@inject IMediator Mediator

<div>
    @if (isLoading)
    {
        <LoadingSpinner Message="Loading boards..." />
    }
    else if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <ErrorAlert ErrorMessage="@errorMessage" />
    }
    else
    {
        <div class="mb-3">
            <input type="text"
                   class="form-control"
                   placeholder="Search boards..."
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @onkeyup="FilterBoards" />
        </div>

        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
            @foreach (var board in filteredBoards)
            {
                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedBoard?.Id == board.Id ? "active" : "")"
                        @onclick="@(() => SelectBoard(board))">
                    <div>
                        <div class="fw-semibold">@board.Name</div>
                        <small class="text-muted">@board.Description</small>
                    </div>
                    <small class="text-muted">@board.Length x @board.Width mm</small>
                </button>
            }

            @if (!filteredBoards.Any())
            {
                <div class="alert alert-info mb-0">
                    No boards found.
                </div>
            }
        </div>

        @if (selectedBoard != null)
        {
            <div class="mt-3 border rounded p-3 bg-light">
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Quantity</label>
                        <input type="number"
                               class="form-control"
                               min="1"
                               @bind="quantity" />
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary"
                                @onclick="Confirm"
                                disabled="@(quantity < 1)">
                            <span class="bi bi-plus-circle"></span> Add board
                        </button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public EventCallback<BoardSelectionResult> OnBoardSelected { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private List<Board> boards = new();
    private List<Board> filteredBoards = new();
    private Board? selectedBoard;
    private string? searchTerm;
    private int quantity = 1;
    private bool isLoading;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadBoardsAsync();
    }

    private async Task LoadBoardsAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var result = await Mediator.Send(new GetAllBoardsQuery());
            if (result.Success)
            {
                boards = result.GetOk().ToList();
                filteredBoards = boards;
            }
            else
            {
                errorMessage = result.GetError().Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading boards: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectBoard(Board board)
    {
        selectedBoard = board;
        quantity = 1;
    }

    private void FilterBoards()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredBoards = boards;
        }
        else
        {
            var term = searchTerm.ToLowerInvariant();
            filteredBoards = boards.Where(b =>
                b.Name.ToLowerInvariant().Contains(term) ||
                b.Description.ToLowerInvariant().Contains(term)).ToList();
        }
    }

    private async Task Confirm()
    {
        if (selectedBoard == null || quantity < 1)
        {
            return;
        }

        await OnBoardSelected.InvokeAsync(new BoardSelectionResult
        {
            BoardId = selectedBoard.Id,
            BoardName = selectedBoard.Name,
            Quantity = quantity
        });
    }

    private async Task Cancel()
    {
        await OnCancel.InvokeAsync();
    }

    public class BoardSelectionResult
    {
        public Guid BoardId { get; set; }
        public string BoardName { get; set; } = string.Empty;
        public int Quantity { get; set; }
    }
}
